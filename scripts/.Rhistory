# Analyze effects of sst variability on salmon catch
# within the historical record (1965-2021)
library(plyr)
library(reshape2)
library(ggplot2)
library(rstan)
library(brms)
dir.create("./outputs", showWarnings = FALSE)
dir.create("./figures", showWarnings = FALSE)
cols <- as.vector(palette.colors(palette = "Okabe-Ito"))
theme_set(theme_bw())
## Clean catch data ----------------------------------------
## Read in data
goa_catch <- read.csv("./data/goa.catch.csv")
goa_sst   <- read.csv("./data/goa.sst.csv")
goa_age   <- read.csv("./data/goa_age.csv")
bc_age    <- read.csv("./data/bc_age.csv")
## Subset years
goa_catch <- goa_catch[goa_catch$year >= 1965, ]
## Sum across catch regions
sock <- plyr::ddply(goa_catch, .(year), summarize, catch = sum(sockeye))
coho <- plyr::ddply(goa_catch, .(year), summarize, catch = sum(coho))
pink <- plyr::ddply(goa_catch, .(year), summarize, catch = sum(pink))
chum <- plyr::ddply(goa_catch, .(year), summarize, catch = sum(chum))
pink_even <- pink[pink$year %% 2 == 0, ]
pink_odd  <- pink[pink$year %% 2 != 0, ]
## Add species
sock$species <- "Sockeye"
coho$species <- "Coho"
chum$species <- "Chum"
pink$species <- "Pink"
pink_even$species <- "Pink even"
pink_odd$species  <- "Pink odd"
## Combine in long format
catch <- rbind(sock, coho, chum, pink_even, pink_odd)
## Add era variable
catch$era <- ifelse(catch$year <= 1988, "1977-1988", "1989-2013")
catch$era <- ifelse(catch$year >= 2014, "2014-2021", catch$era)
catch$era <- ifelse(catch$year <= 1976, "1950-1976", catch$era)
## Scale catch
catch <- plyr::ddply(catch, .(species), transform,
log_catch = log(catch),
log_catch_stnd = scale(log(catch)),
catch_stnd = scale(catch))
# ML: quick thought - the signal of increasing chum hatchery production appears
# to be clear in the late 1980s and 1990s perhaps we should control for GOA
# hatchery inputs of chum and pink
## Combine catch + sst -------------------------------------
## "winter" = November-March (year corresponding to January);
##            annual = January - December both winter and annual data scaled wrt
##            20th century (1901-1999 for winter; 1900-1999 for annual)
## .2 denotes two-yr running mean (year of and year following year of interest)
## .3 denotes three-yr running mean (year before, year of, and year following year of interest)
## Get mean age props for sockeye
o1 <- mean(goa_age$R_ocean_1)
o2 <- mean(goa_age$R_ocean_2)
o3 <- mean(goa_age$R_ocean_3)
o4 <- mean(goa_age$R_ocean_4)
o5 <- mean(goa_age$R_ocean_5)
age_wgt <- c(o1, o2, o3, o4, o5)
## Add SST
catch$annual_sst   <- NA
catch$annual_sst_2 <- NA
catch$annual_sst_3 <- NA
catch$winter_sst   <- NA
catch$winter_sst_2 <- NA
catch$winter_sst_3 <- NA
for(i in 1:nrow(catch)) {
yr <- catch$year[i]
sp <- catch$species[i]
if(sp == "Chum") {
sst_i <- goa_sst[goa_sst$year == yr - 3, ]
annual_sst   <- sst_i$annual.sst
annual_sst_2 <- sst_i$annual.sst.2
annual_sst_3 <- sst_i$annual.sst.2
winter_sst   <- sst_i$winter.sst
winter_sst_2 <- sst_i$winter.sst.2
winter_sst_3 <- sst_i$winter.sst.2
}
if(sp %in% c("Coho", "Pink", "Pink even", "Pink odd")) {
sst_i <- goa_sst[goa_sst$year == yr - 1, ]
annual_sst   <- sst_i$annual.sst
annual_sst_2 <- sst_i$annual.sst.2
annual_sst_3 <- sst_i$annual.sst.2
winter_sst   <- sst_i$winter.sst
winter_sst_2 <- sst_i$winter.sst.2
winter_sst_3 <- sst_i$winter.sst.2
}
if(sp == "Sockeye") {
sst_i <- goa_sst[goa_sst$year %in% (yr - 1):(yr - 5), ]
annual_sst   <- weighted.mean(sst_i$annual.sst, w = rev(age_wgt))
annual_sst_2 <- weighted.mean(sst_i$annual.sst.2, w = rev(age_wgt))
annual_sst_3 <- weighted.mean(sst_i$annual.sst.3, w = rev(age_wgt))
winter_sst   <- weighted.mean(sst_i$winter.sst, w = rev(age_wgt))
winter_sst_2 <- weighted.mean(sst_i$winter.sst.2, w = rev(age_wgt))
winter_sst_3 <- weighted.mean(sst_i$winter.sst.3, w = rev(age_wgt))
}
catch$annual_sst[i]   <- annual_sst
catch$annual_sst_2[i] <- annual_sst_2
catch$annual_sst_3[i] <- annual_sst_3
catch$winter_sst[i]   <- winter_sst
catch$winter_sst_2[i] <- winter_sst_2
catch$winter_sst_3[i] <- winter_sst_3
}
## Save catch data
write.csv(catch, file = "./data/catch.csv", row.names = FALSE)
